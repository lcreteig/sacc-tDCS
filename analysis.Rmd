---
title: "Transcranial direct current stimulation of the right frontal eye field in a prosaccade task"
author: Leon Reteig
output:
  html_notebook:
    toc: yes
    toc-depth: 2
---

```{r include=FALSE}
# Don't show warnings and messages in HTML output
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

R notebook for statistical analysis of the `sacc-tDCS` dataset. Previous processing:

* Raw data were parsed into events (saccades, fixations, etc.) by the EyeLink data were collected on.
* Events were extracted and saccade measures were computed with a MATLAB script.

# Load data

```{r Load some libraries}
# Load some libraries
library("tidyr") # tidying data frames
library("dplyr") # wrangling data frame data
library("ggplot2") # plotting
library("ez") # ANOVA
library("knitr") # R markdown output (html, pdf, etc.)
```

The .csv file was created in MATLAB.
```{r, echo=TRUE}
# Load the data frame
dataFile <- file.path("data", "sacc-tDCS_data.csv")
groupData <- read.csv(dataFile, header = TRUE, na.strings = "NaN")

```

```{r}
# Format data frame
groupData <- select(groupData, -X) # drop final empty column named "X"
groupData$leg <- factor(groupData$leg, levels = c("pre", "tDCS", "post")) # reorder levels chronologically instead of alphabetically
```

```{r}
kable(head(groupData))
```

* __subject__: subject IDj
* __stimulation__: Whether data are from the anodal or cathodal session
* __leg__: Whether data are before (`pre`), during (`tDCS`), or after (`post`) tDCS
* __block__: After each block participant had a brief break and tracker was recalibrated
* __trial__: trial number within a block
* __type__:
    * `lateral` - fixation in center of display, saccade made towards the periphery
    * `center` - fixation in periphery, saccade made back towards the center of the display
* __direction__: `left` for saccades towards the left of current fixation position; `right` for saccades to the right
* __deviation.start__ : distance (in visual angle) from saccade start point to fixation
* __deviation.end__: distance (in visual angle) from saccade end point to target location
* __amplitude__: distance (in visual angle) between saccade start and end point
* __latency__: time (in ms) from target onset to start of saccade

# Basic inspection

##  Reaction time distributions

### Histograms for each subject 

```{r fig.width=9.6}
histType <- ggplot(groupData, aes(latency, fill = type)) +
  facet_wrap(~subject, nrow = 3, scales ="free_y") +
  geom_histogram(binwidth = 5, color = "grey50", size = .2) +
  xlim(-50,300)
histType
```

__Stray observations:__

* Center saccades are much faster than lateral, though not to the same degree in all subjects
* Some have a fat short latency tail - too fast saccades that are virtually all towards the center: S05, S10, S11
* Some appear bimodal, but when split for type this is generally because center saccades are faster: S05, S06, S11
* Some are super sharp (S8); others really broad (S01)
* S01 has a very typical looking distribution, but slow

### Stimulation effects across subjects

```{r fig.width=9.6}
dens <- ggplot(groupData, aes(latency, color = stimulation, linetype = leg)) +
  facet_grid(type ~ direction) +
  geom_density() +
  xlim(0, 250) +
  scale_color_brewer(palette = "Set1")
dens
```

### Anodal vs. cathodal in each subject
```{r fig.width= 9.6}
denstDCS <- ggplot(groupData[groupData$leg == 'tDCS' & groupData$type == "lateral", ], aes(latency, color = stimulation)) +
  facet_wrap(~subject, nrow = 3, scales ="free_y") +
  geom_density() +
  xlim(0, 250) +
  scale_color_brewer(palette = "Set1") +
  ggtitle('Lateral saccades, tDCS block')
denstDCS
```

### Anodal session in each subject

```{r fig.width=9.6}
densLegAnodal <- ggplot(groupData[groupData$stimulation == 'anodal' & groupData$type == "lateral", ], aes(latency, color = leg)) +
  facet_wrap(~subject, nrow = 3, scales ="free_y") +
  geom_density() +
  xlim(0, 250) +
  ggtitle('Lateral saccades, anodal')
densLegAnodal
```

### Cathodal session in each subject
```{r, fig.width=9.6}
densLegCathodal <- ggplot(groupData[groupData$stimulation == 'cathodal' & groupData$type == "lateral", ], aes(latency, color = leg)) +
  facet_wrap(~subject, nrow = 3, scales ="free_y") +
  geom_density() +
  xlim(0, 250) +
  ggtitle('Lateral saccades, cathodal')
densLegCathodal
```

# Outliers

## Mark outliers

```{r, include=FALSE}
tooFast= 50;
tooSlow = 400; 
badFix = 1.8;
badSacc = 8;
```

Criteria for outliers:

* Discard fast saccades, with a latency of `r tooFast` ms or less
* Discard slow saccades, saccades with a latency of `r tooSlow` ms or more
* Discard inaccurate fixations, with saccade starting point more than `r badFix` degrees or more away from fixation
* Discard faulty saccades, with saccade end point more than `r badSacc` degree or more away from the target

In [Kanai et al. (2012)](http://dx.doi.org/10.3389/fpsyt.2012.00045), this was:

* Fast saccades: 50 ms
* Slow saccades: 400 ms
* Bad fixations: 1.8 degrees
* Faulty saccades: opposite hemifield of target (here, that would be 8 degrees as targets were that eccentric)

```{r}
# Mark outliers
groupData <- mutate(groupData, outlier = FALSE, # fill vector with FALSE for all trials
                    outlier = ifelse(latency < tooFast, "fast", outlier), # mark too fast trials as "fast"
                    outlier = ifelse(latency > tooSlow, "slow", outlier), # mark too slow trials as "slow"
                    outlier = ifelse(deviation.start > badFix, "fixation", outlier), # mark bad fixations as "fixation"
                    outlier = ifelse(deviation.end > badSacc, "saccade", outlier)) # mark inaccurate saccades as "saccade"

groupDataClean <- filter(groupData, outlier == FALSE) # make new data frame without outlier trials
```

## Plot outliers per subject

```{r, fig.width=9.6}
outlierPlot <- ggplot(groupData[groupData$outlier != FALSE, ], aes(interaction(stimulation,leg,block,trial), latency, color = outlier, shape = type)) +
  facet_wrap(~subject, nrow = 4, scales = "free_y") +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = tooFast, linetype = "dashed") +
  geom_hline(yintercept = tooSlow, linetype = "dashed") +
  xlab('Trial') +
  theme(axis.text.x=element_blank(), # remove x-axis (just trial count)
  axis.ticks.x=element_blank())
outlierPlot
```

```{r results='asis'}
outlierCount <- groupData %>%
  group_by(subject) %>%
  summarize(outlier_count = sum(outlier != FALSE, na.rm = TRUE))
kable(outlierCount, caption = "Number of outlier trials per subject")
```

__Stray observations:__

Differences between subjects:

* Some subjects have barely any outliers (S02, S07)
* Most subjects have quite a few outliers, especially S05,S06, S10 and S1. The mean is `r mean(outlierCount$outlier_count)` out of `r sum(groupData$subject == "S01")` trials in total
* Only S01 has a sizable amount of slow saccades
* S14 has a lot of negative latencies (and also long positive latencies)
* Those subjects with many fast saccades also tend to have many bad fixations (S06, S10, but see S08)

General patterns:

* Occurence of outliers seems stable throughout the session: there aren't more/less in the beginning / end
* There are very few inaccurate saccades (makes sense, because task is easy and criterion is not strict)
* Most outliers are too fast saccades and bad fixations
* Slow saccades are lateral, fast saccades are to the center, because only the latter are predictable
* Bad fixations appear to be mostly center saccades (but this varies a lot). Perhaps the eyes already drift back towards the center, before executing the saccade?
* Or is the source of bad fixations simply poor quality of the eye tracker data? e.g. people are actually fixating, but due to drift it appears they are not.

