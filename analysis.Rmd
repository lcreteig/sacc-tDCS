---
title: "Transcranial direct current stimulation of the right frontal eye field in a prosaccade task"
author: Leon Reteig
output:
  html_notebook:
    toc: true
    toc_depth: 2
---

```{r include=FALSE}
# Don't show warnings and messages in HTML output
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

R notebook for statistical analysis of the `sacc-tDCS` dataset. Previous processing:

* Raw data were parsed into events (saccades, fixations, etc.) by the EyeLink data were collected on.
* Events were extracted and saccade measures were computed with a MATLAB script.

# Load data

```{r Load some libraries}
# Load some libraries
library("tidyr") # tidying data frames
library("dplyr") # wrangling data frame data
library("ggplot2") # plotting
library("ez") # ANOVA
library("knitr") # R markdown output (html, pdf, etc.)
library("BayesFactor")
```

The .csv file was created in MATLAB.
```{r Load the data frame, echo=TRUE}
# Load the data frame
dataFile <- file.path("data", "sacc-tDCS_data.csv")
groupData <- read.csv(dataFile, header = TRUE, na.strings = "NaN")

```

```{r Format data frame}
# Format data frame
groupData <- select(groupData, -X) # drop final empty column named "X"
groupData$leg <- factor(groupData$leg, levels = c("pre", "tDCS", "post")) # reorder levels chronologically instead of alphabetically
```

```{r Show data frame}
kable(head(groupData))
```

* __subject__: subject IDj
* __stimulation__: Whether data are from the anodal or cathodal session
* __leg__: Whether data are before (`pre`), during (`tDCS`), or after (`post`) tDCS
* __block__: After each block participant had a brief break and tracker was recalibrated
* __trial__: trial number within a block
* __type__:
    * `lateral` - fixation in center of display, saccade made towards the periphery
    * `center` - fixation in periphery, saccade made back towards the center of the display
* __direction__: `left` for saccades towards the left of current fixation position; `right` for saccades to the right
* __deviation.start__ : distance (in visual angle) from saccade start point to fixation
* __deviation.end__: distance (in visual angle) from saccade end point to target location
* __amplitude__: distance (in visual angle) between saccade start and end point
* __latency__: time (in ms) from target onset to start of saccade

# Basic inspection

##  Reaction time distributions

### Histograms for each subject 

```{r Histogram per subject, fig.width=9.6}
histType <- ggplot(groupData, aes(latency, fill = type)) +
  facet_wrap(~subject, nrow = 3, scales ="free_y") +
  geom_histogram(binwidth = 5, color = "grey50", size = .2) +
  xlim(-50,300)
histType
```

__Stray observations:__

* Center saccades are much faster than lateral, though not to the same degree in all subjects
* Some have a fat short latency tail - too fast saccades that are virtually all towards the center: S05, S10, S11
* Some appear bimodal, but when split for type this is generally because center saccades are faster: S05, S06, S11
* Some are super sharp (S8); others really broad (S01)
* S01 has a very typical looking distribution, but slow

### Stimulation effects across subjects

```{r Density: stimulation across subjects, fig.width=9.6}
dens <- ggplot(groupData, aes(latency, color = stimulation, linetype = leg)) +
  facet_grid(type ~ direction) +
  geom_density() +
  xlim(0, 250) +
  scale_color_brewer(palette = "Set1")
dens
```

### Anodal vs. cathodal in each subject
```{r Density: anodal vs. cathodal per subject, fig.width=9.6}
denstDCS <- ggplot(groupData[groupData$leg == 'tDCS' & groupData$type == "lateral", ], aes(latency, color = stimulation)) +
  facet_wrap(~subject, nrow = 3, scales ="free_y") +
  geom_density() +
  xlim(0, 250) +
  scale_color_brewer(palette = "Set1") +
  ggtitle('Lateral saccades, tDCS block')
denstDCS
```

### Anodal session in each subject

```{r Density: anodal per leg and subject, fig.width=9.6}
densLegAnodal <- ggplot(groupData[groupData$stimulation == 'anodal' & groupData$type == "lateral", ], aes(latency, color = leg)) +
  facet_wrap(~subject, nrow = 3, scales ="free_y") +
  geom_density() +
  xlim(0, 250) +
  ggtitle('Lateral saccades, anodal')
densLegAnodal
```

### Cathodal session in each subject
```{r Density: cathodal per leg and subject, fig.width=9.6}
densLegCathodal <- ggplot(groupData[groupData$stimulation == 'cathodal' & groupData$type == "lateral", ], aes(latency, color = leg)) +
  facet_wrap(~subject, nrow = 3, scales ="free_y") +
  geom_density() +
  xlim(0, 250) +
  ggtitle('Lateral saccades, cathodal')
densLegCathodal
```

# Outliers

## Mark outliers

```{r Outlier criteria, include=FALSE}
tooFast= 50;
tooSlow = 400; 
badFix = 1.8;
badSacc = 8;
```

Criteria for outliers:

* Discard fast saccades, with a latency of `r tooFast` ms or less
* Discard slow saccades, saccades with a latency of `r tooSlow` ms or more
* Discard inaccurate fixations, with saccade starting point more than `r badFix` degrees or more away from fixation
* Discard faulty saccades, with saccade end point more than `r badSacc` degree or more away from the target

In [Kanai et al. (2012)](http://dx.doi.org/10.3389/fpsyt.2012.00045), this was:

* Fast saccades: 50 ms
* Slow saccades: 400 ms
* Bad fixations: 1.8 degrees
* Faulty saccades: opposite hemifield of target (here, that would be 8 degrees as targets were that eccentric)

```{r Mark trials as outliers}
# Mark outliers
groupData <- mutate(groupData, outlier = FALSE, # fill vector with FALSE for all trials
                    outlier = ifelse(latency < tooFast, "fast", outlier), # mark too fast trials as "fast"
                    outlier = ifelse(latency > tooSlow, "slow", outlier), # mark too slow trials as "slow"
                    outlier = ifelse(deviation.start > badFix, "fixation", outlier), # mark bad fixations as "fixation"
                    outlier = ifelse(deviation.end > badSacc, "saccade", outlier)) # mark inaccurate saccades as "saccade"

groupDataClean <- filter(groupData, outlier == FALSE) # make new data frame without outlier trials
```

## Plot outliers per subject

```{r Plot outliers per subject, fig.width=9.6}
outlierPlot <- ggplot(groupData[groupData$outlier != FALSE, ], aes(interaction(stimulation,leg,block,trial), latency, color = outlier, shape = type)) +
  facet_wrap(~subject, nrow = 4, scales = "free_y") +
  geom_point() +
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = tooFast, linetype = "dashed") +
  geom_hline(yintercept = tooSlow, linetype = "dashed") +
  xlab('Trial') +
  theme(axis.text.x=element_blank(), # remove x-axis (just trial count)
  axis.ticks.x=element_blank())
outlierPlot
```

```{r Table of outlier counts, results='asis'}
outlierCount <- groupData %>%
  group_by(subject) %>%
  summarize(outlier_count = sum(outlier != FALSE, na.rm = TRUE))
kable(outlierCount, caption = "Number of outlier trials per subject")
```

__Stray observations:__

Differences between subjects:

* Some subjects have barely any outliers (S02, S07)
* Most subjects have quite a few outliers, especially S05,S06, S10 and S1. The mean is `r mean(outlierCount$outlier_count)` out of `r sum(groupData$subject == "S01")` trials in total
* Only S01 has a sizable amount of slow saccades
* S14 has a lot of negative latencies (and also long positive latencies)
* Those subjects with many fast saccades also tend to have many bad fixations (S06, S10, but see S08)

General patterns:

* Occurence of outliers seems stable throughout the session: there aren't more/less in the beginning / end
* There are very few inaccurate saccades (makes sense, because task is easy and criterion is not strict)
* Most outliers are too fast saccades and bad fixations
* Slow saccades are lateral, fast saccades are to the center, because only the latter are predictable
* Bad fixations appear to be mostly center saccades (but this varies a lot). Perhaps the eyes already drift back towards the center, before executing the saccade?
* Or is the source of bad fixations simply poor quality of the eye tracker data? e.g. people are actually fixating, but due to drift it appears they are not.

# Summary analysis

Here we simply extract median RTs for each condition and use a repeated measures ANOVA for statistical analysis, following [Kanai et al. (2012)](http://dx.doi.org/10.3389/fpsyt.2012.00045).

## Data per block

```{r Compute median in each condition}
# Compute median in each condition
latencyMedian <- groupDataClean %>%
  group_by(subject,stimulation,leg,block,type,direction) %>%
  summarise(latency = median(latency, na.rm = TRUE))
```

### Full factorial plot

```{r Full factorial plot, fig.width=9.6}
# Plot out all the data
fullPlot <- ggplot(latencyMedian, aes(interaction(block,leg), latency, color = stimulation, shape = stimulation)) +
  facet_grid(type ~ direction) +
  stat_summary(fun.y = mean, geom = "point", size = 3) +
  stat_summary(fun.y = mean, geom = "line", aes(group = stimulation), size = 1)
fullPlot
```

## 15-minute intervals (collapse 3 blocks)

This shows a lot of variability, so it might be best to average over each 3 consecutive blocks so the data come in 15-minute intervals.

```{r Compute median, collapsed across blocks}
# Compute median per leg
latencyMedianLeg <- groupDataClean %>%
  group_by(subject,stimulation,direction,type) %>% 
  summarise(baseline = median(latency[leg == "pre"], na.rm = TRUE), # take average of 3 blocks, make new column
            tDCS = median(latency[leg == "tDCS"], na.rm = TRUE),
            post.1 = median(latency[leg == "post" & block <= 3], na.rm = TRUE),
            post.2 = median(latency[leg == "post" & block >= 4], na.rm = TRUE)) %>%
 gather(leg,latency,baseline,tDCS,post.1,post.2) %>% # gather new columns to use as factor
 mutate(leg = factor(leg, levels = c("baseline", "tDCS", "post.1", "post.2"))) # reorder factor levels
```

### Line plot per leg

```{r Line plot per leg}
kanaiPlot <- ggplot(latencyMedianLeg, aes(leg, latency, color = stimulation, shape = stimulation)) +         
  facet_grid(type ~ direction) +
  stat_summary(fun.y = mean, geom = "point", size = 3) +
  stat_summary(fun.y = mean, geom = "line", aes(group = stimulation), size = 1) +
  stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0.3)
kanaiPlot
```

## Difference from baseline

There's a difference between stimulation sessions in the baseline already: anodal is always faster than cathodal.

### Individual subjects

Make the same line plot for individual subjects to show differences between the sessions.

```{r Line plot for each subject, fig.width=9.6}
kanaiSubsPlot <- ggplot(latencyMedianLeg, aes(leg, latency, color = stimulation, shape = type)) +         
  facet_wrap(~subject, nrow = 5) +
  stat_summary(fun.y = mean, geom = "point", size = 2) +
  stat_summary(fun.y = mean, geom = "line", aes(group = stimulation))
kanaiSubsPlot
```

### Compute magnitude of baseline difference

Calculate baseline difference between anodal and cathodal sessions per subject.

```{r results = 'asis'}
baselineDiff <- latencyMedianLeg %>% 
  filter(leg == "baseline") %>% # keep only baseline data
  spread(stimulation, latency) %>% # make separate columns for anodal and cathodal
  mutate(latency.diff = anodal - cathodal) %>% # subtract the difference
  group_by(subject) %>% 
  summarise(latency.diff = mean(latency.diff))# keep the average difference per subject

kable(baselineDiff, caption = 'Difference between baseline saccade latencies in anodal and cathodal session')
```

There are a few subjects with substantial latency differences between sessions; the three largest of which are all slower in the anodal session (positive values). The mean difference is `r mean(baselineDiff$latency.diff)` ms.

## Subtract baseline

The baseline difference is not informative and could obscure real changes from baseline within subjects. Therefore, subtract the baseline from each subsequent measurement.

```{r Subtract baseline}
latencyMedianBaseline <- latencyMedianLeg %>%
  group_by(subject,stimulation,direction,type) %>% # for each condition, subtract baseline scores and make new columns
  summarise(tDCS = latency[leg == "tDCS"] - latency[leg == "baseline"], 
           post.1 = latency[leg == "post.1"] - latency[leg == "baseline"],
           post.2 = latency[leg == "post.2"] - latency[leg == "baseline"]) %>%
  gather(leg, latency, tDCS, post.1, post.2)  %>% # gather new columns to use as factor 
  mutate(leg = factor(leg, levels = c("tDCS", "post.1", "post.2"))) # reorder factor levels
```

### Line plots per leg from baseline

```{r Line plot from baseline}
kanaiPlotBase <- ggplot(latencyMedianBaseline, aes(leg, latency, color = stimulation, shape = stimulation)) +         
  facet_grid(type ~ direction) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  stat_summary(fun.y = mean, geom = "point", size = 3) +
  stat_summary(fun.y = mean, geom = "line", aes(group = stimulation), size = 1) +
  stat_summary(fun.data = mean_cl_normal, geom = "errorbar", width = 0.3) +
  coord_cartesian(ylim = c(-15,15))
kanaiPlotBase
```

For the left (contralateral) saccades, both stimulation effects are in the right direction (anodal: faster ; cathodal: no effect or slower). But they are tiny: 5 ms or less.

### Individual subjects, anodal session

```{r Line plot per subject - anodal}
kanaiPlotBaseSubsAnodal <- ggplot(latencyMedianBaseline[latencyMedianBaseline$stimulation == "anodal", ], aes(leg, latency)) +
  facet_grid(type ~ direction) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_line(aes(group=subject,color=subject)) +
  stat_summary(fun.y = mean, aes(group = stimulation), geom = "line") +
  stat_summary(fun.y = mean, geom = "point") +
  ggtitle("Anodal difference from baseline")
kanaiPlotBaseSubsAnodal
```

The left-center effect is mostly caused by one subject. The left-lateral effect is quite erratic: only ~10 subjects are below the line, and none show an effect larger than 10 ms.

### Individual subjects, cathodal session

```{r Line plot per subject - cathodal}
kanaiPlotBaseSubsCathodal <- ggplot(latencyMedianBaseline[latencyMedianBaseline$stimulation == "cathodal", ], aes(leg, latency)) +
  facet_grid(type ~ direction) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_line(aes(group=subject,color=subject)) +
  stat_summary(fun.y = mean, aes(group = stimulation), geom = "line") +
  stat_summary(fun.y = mean, geom = "point") + 
  ggtitle("Cathodal difference from baseline")
kanaiPlotBaseSubsCathodal
```

All of this is split pretty much 50-50, hence the average difference hovering around 0.

# Statistics

## Omnibus anova - saccade latency

__Data__: Outliers removed, collapesed into 15-minute intervals. 

__Dependent measure__: saccadic latency

__Factors__:

* STIMULATION (anodal vs. cathodal)
* LEG (baseline, tDCS, post.1, post.2)
* TYPE (lateral vs. center)
* DIRECTION (left vs. right)

```{r Omnibus ANOVA, results='asis'}
modelOmni <- ezANOVA(data = data.frame(latencyMedianLeg), # Repeated over subjects; type 3 sums of squares (cf. SPSS)
                        dv = .(latency), wid = .(subject), within = .(stimulation, leg, type, direction), type = 3)
kable(modelOmni$ANOVA)
```

### Main effect: type

```{r Main effect of type}
latencyMedianLeg %>%
  group_by(subject,type) %>%
  summarise(latency = mean(latency)) %>%
  ggplot(aes(type, latency)) +
  stat_summary(fun.data = mean_cl_normal, size = 1) +
  geom_jitter(width = 0.25)
```

This simply reflects that center saccades are faster than lateral saccades, because the location of the target is known.

### Interaction: leg by type

```{r Interaction leg by type}
latencyMedianLeg %>%
  group_by(subject,leg,type) %>%
  summarise(latency = mean(latency)) %>%
  ggplot(aes(leg, latency, shape = type)) +
  stat_summary(fun.y = mean, geom = "point") +
  stat_summary(fun.y = mean, geom = "line", aes(group = type, linetype = type))
```

The effect of TYPE becomes larger over time: center saccades get faster, lateral saccades become slower.

### Interaction: leg by type by direction

```{r Interaction leg by type by direction}
latencyMedianLeg %>%
  group_by(subject,leg,type,direction) %>%
  summarise(latency = mean(latency)) %>%
  ggplot(aes(leg, latency, shape = type)) +
  facet_wrap(~direction) +
  stat_summary(fun.y = mean, geom = "point") +
  stat_summary(fun.y = mean, geom = "line", aes(group = type, linetype = type))
```

This interaction of LEG and TYPE appears to occur to a lesser extent for left saccades. The "tDCS" block is the deviant here, but there is no interaction with stimulation.

## ANOVA matching Kanai et al. (2012) - saccade latency

Differing from the previous omnibus analysis, [Kanai et al. (2012)](http://dx.doi.org/10.3389/fpsyt.2012.00045) analysed shifts from baseline and only had lateral saccades.

__Data__: 
* Outliers removed
* Collapsed into 15-minute intervals
* Subtract the baseline from each subsequent block
* Discard center, keep only lateral saccades

__Dependent measure__: saccadic latency

__Factors__:

* STIMULATION (anodal vs. cathodal)
* LEG (tDCS, post.1, post.2)
* DIRECTION (left vs. right)

```{r Kanai ANOVA, results='asis'}

latencyMedianBaselineLateral <- filter(latencyMedianBaseline, type == "lateral") # keep only lateral saccades

modelKanai <- ezANOVA(data = data.frame(latencyMedianBaselineLateral),
                        dv = .(latency), wid = .(subject), within = .(stimulation,leg,direction), type = 3)

# OR, without the EZ package:
# modelKanai=aov(latency~stimulation*leg*direction + Error(subject/(stimulation*leg*direction)),data=latencyMedianBaselineLateral)
# summary(modelKanai)

kable(modelKanai$ANOVA)
```

### Main effect of direction

```{r Main effect of direction}
latencyMedianBaselineLateral %>%
  group_by(subject,direction) %>%
  summarise(latency = mean(latency)) %>%
  ggplot(aes(direction, latency)) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  stat_summary(fun.data = mean_cl_normal, size = 1) +
  geom_jitter(width = 0.25)
```

Right saccades become slower with respect to the baseline; left saccades do not. However, the effect is tiny (1-2 ms) and there is no interaction with STIMULATION.

